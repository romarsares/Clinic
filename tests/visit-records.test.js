/**\n * Visit Records Module - Test Suite\n * \n * Author: Romar Tabaosares\n * Created: 2024-12-19\n * Purpose: Comprehensive tests for Phase 2 Step 1 - Visit Records Module\n * \n * This test suite validates:\n * - Visit creation and retrieval\n * - Clinical documentation endpoints\n * - Role-based access control\n * - Audit logging functionality\n * - Data validation and error handling\n */\n\nconst request = require('supertest');\nconst app = require('../src/server');\nconst db = require('../src/config/database');\n\ndescribe('Visit Records Module - Phase 2 Step 1', () => {\n  let doctorToken, staffToken, visitId;\n  \n  beforeAll(async () => {\n    // Setup test database connection\n    await db.testConnection();\n    \n    // Mock JWT tokens for testing (replace with actual token generation)\n    doctorToken = 'mock_doctor_jwt_token';\n    staffToken = 'mock_staff_jwt_token';\n  });\n\n  afterAll(async () => {\n    // Clean up database connections\n    await db.closePool();\n  });\n\n  describe('Visit Creation', () => {\n    test('should create a new visit with valid data', async () => {\n      const visitData = {\n        appointment_id: 1,\n        patient_id: 1,\n        doctor_id: 1\n      };\n\n      const response = await request(app)\n        .post('/api/v1/visits')\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send(visitData)\n        .expect(201);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data).toHaveProperty('id');\n      visitId = response.body.data.id;\n    });\n\n    test('should reject visit creation without authentication', async () => {\n      const visitData = {\n        appointment_id: 1,\n        patient_id: 1,\n        doctor_id: 1\n      };\n\n      await request(app)\n        .post('/api/v1/visits')\n        .send(visitData)\n        .expect(401);\n    });\n\n    test('should validate required fields', async () => {\n      const invalidData = {\n        appointment_id: 1\n        // Missing patient_id and doctor_id\n      };\n\n      const response = await request(app)\n        .post('/api/v1/visits')\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send(invalidData)\n        .expect(400);\n\n      expect(response.body.errors).toBeDefined();\n    });\n  });\n\n  describe('Chief Complaint Documentation', () => {\n    test('should add chief complaint successfully', async () => {\n      const complaintData = {\n        complaint: 'Patient complains of fever and cough for 3 days'\n      };\n\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/chief-complaint`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(complaintData)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n\n    test('should require complaint text', async () => {\n      await request(app)\n        .put(`/api/v1/visits/${visitId}/chief-complaint`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send({})\n        .expect(400);\n    });\n  });\n\n  describe('Diagnosis Management (Doctor Only)', () => {\n    test('should allow doctor to add diagnosis', async () => {\n      const diagnosisData = {\n        diagnosis_type: 'primary',\n        diagnosis_code: 'J06.9',\n        diagnosis_name: 'Acute upper respiratory infection, unspecified',\n        clinical_notes: 'Patient presents with typical symptoms of viral URTI'\n      };\n\n      const response = await request(app)\n        .post(`/api/v1/visits/${visitId}/diagnoses`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send(diagnosisData)\n        .expect(201);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data).toHaveProperty('id');\n    });\n\n    test('should reject staff from adding diagnosis', async () => {\n      const diagnosisData = {\n        diagnosis_name: 'Some diagnosis'\n      };\n\n      const response = await request(app)\n        .post(`/api/v1/visits/${visitId}/diagnoses`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(diagnosisData)\n        .expect(403);\n\n      expect(response.body.message).toContain('Only doctors can add diagnoses');\n    });\n\n    test('should validate diagnosis name is required', async () => {\n      await request(app)\n        .post(`/api/v1/visits/${visitId}/diagnoses`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send({})\n        .expect(400);\n    });\n  });\n\n  describe('Vital Signs Recording', () => {\n    test('should record vital signs with BMI calculation', async () => {\n      const vitalsData = {\n        temperature: 38.5,\n        blood_pressure_systolic: 120,\n        blood_pressure_diastolic: 80,\n        heart_rate: 85,\n        respiratory_rate: 18,\n        weight: 25.5,\n        height: 120.0,\n        oxygen_saturation: 98\n      };\n\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/vital-signs`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(vitalsData)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data).toHaveProperty('bmi');\n    });\n\n    test('should validate vital signs ranges', async () => {\n      const invalidVitals = {\n        temperature: 100, // Invalid temperature\n        heart_rate: 500   // Invalid heart rate\n      };\n\n      await request(app)\n        .put(`/api/v1/visits/${visitId}/vital-signs`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(invalidVitals)\n        .expect(400);\n    });\n  });\n\n  describe('Clinical Assessment (Doctor Only)', () => {\n    test('should allow doctor to add clinical assessment', async () => {\n      const assessmentData = {\n        assessment: 'Patient appears well, no signs of respiratory distress. Throat slightly erythematous.'\n      };\n\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/clinical-assessment`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send(assessmentData)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n\n    test('should reject staff from adding clinical assessment', async () => {\n      const assessmentData = {\n        assessment: 'Some assessment'\n      };\n\n      await request(app)\n        .put(`/api/v1/visits/${visitId}/clinical-assessment`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(assessmentData)\n        .expect(403);\n    });\n  });\n\n  describe('Treatment Plan (Doctor Only)', () => {\n    test('should allow doctor to add treatment plan', async () => {\n      const treatmentData = {\n        treatment_plan: '1. Paracetamol 250mg every 6 hours\\n2. Increase fluid intake\\n3. Rest and monitor'\n      };\n\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/treatment-plan`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .send(treatmentData)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n\n    test('should reject staff from creating treatment plan', async () => {\n      const treatmentData = {\n        treatment_plan: 'Some treatment plan'\n      };\n\n      await request(app)\n        .put(`/api/v1/visits/${visitId}/treatment-plan`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(treatmentData)\n        .expect(403);\n    });\n  });\n\n  describe('Follow-up Instructions', () => {\n    test('should add follow-up instructions', async () => {\n      const instructionsData = {\n        instructions: 'Return in 3-5 days if symptoms persist or worsen.'\n      };\n\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/follow-up-instructions`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .send(instructionsData)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n  });\n\n  describe('Visit Retrieval', () => {\n    test('should get complete clinical summary', async () => {\n      const response = await request(app)\n        .get(`/api/v1/visits/${visitId}`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n      expect(response.body.data).toHaveProperty('visit');\n      expect(response.body.data).toHaveProperty('notes');\n      expect(response.body.data).toHaveProperty('diagnoses');\n      expect(response.body.data).toHaveProperty('vital_signs');\n    });\n\n    test('should return 404 for non-existent visit', async () => {\n      await request(app)\n        .get('/api/v1/visits/99999')\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .expect(404);\n    });\n  });\n\n  describe('Visit Closure (Doctor Only)', () => {\n    test('should allow doctor to close visit', async () => {\n      const response = await request(app)\n        .put(`/api/v1/visits/${visitId}/close`)\n        .set('Authorization', `Bearer ${doctorToken}`)\n        .expect(200);\n\n      expect(response.body.success).toBe(true);\n    });\n\n    test('should reject staff from closing visit', async () => {\n      await request(app)\n        .put(`/api/v1/visits/${visitId}/close`)\n        .set('Authorization', `Bearer ${staffToken}`)\n        .expect(403);\n    });\n  });\n\n  describe('API Documentation', () => {\n    test('should provide API documentation', async () => {\n      const response = await request(app)\n        .get('/api/v1/docs')\n        .expect(200);\n\n      expect(response.body).toHaveProperty('title');\n      expect(response.body).toHaveProperty('endpoints');\n      expect(response.body.endpoints).toHaveProperty('visits');\n    });\n  });\n\n  describe('Health Checks', () => {\n    test('should return healthy status', async () => {\n      const response = await request(app)\n        .get('/health')\n        .expect(200);\n\n      expect(response.body.status).toBe('healthy');\n    });\n\n    test('should return database health status', async () => {\n      const response = await request(app)\n        .get('/db-health')\n        .expect(200);\n\n      expect(response.body.database.connected).toBe(true);\n    });\n  });\n});\n\n// Helper function to create mock JWT tokens for testing\nfunction createMockToken(userId, clinicId, roles) {\n  // In a real implementation, this would use the actual JWT library\n  // For now, return a mock token that the middleware can recognize\n  return `mock_token_${userId}_${clinicId}_${roles.join(',')}`;\n}\n\n// Test data cleanup helper\nasync function cleanupTestData() {\n  try {\n    // Clean up test visits, diagnoses, vital signs, etc.\n    await db.execute('DELETE FROM visit_vital_signs WHERE visit_id IN (SELECT id FROM visits WHERE patient_id = 999)');\n    await db.execute('DELETE FROM visit_diagnoses WHERE visit_id IN (SELECT id FROM visits WHERE patient_id = 999)');\n    await db.execute('DELETE FROM visit_notes WHERE visit_id IN (SELECT id FROM visits WHERE patient_id = 999)');\n    await db.execute('DELETE FROM visits WHERE patient_id = 999');\n    await db.execute('DELETE FROM audit_logs WHERE clinic_id = 999');\n  } catch (error) {\n    console.error('Test cleanup error:', error);\n  }\n}\n\n// Run cleanup after all tests\nafterAll(async () => {\n  await cleanupTestData();\n});